# https://github.com/zetanumbers/nushell/blob/main/docker/cross-rs/aarch64-unknown-linux-gnu.dockerfile
# https://github.com/cross-rs/cross/wiki/Configuration
# sudo apt-get install pkg-config libssl-dev
# sudo apt-get install -y autoconf automake libtool git
# docker build -f ./Dockerfile_debian -t  rust-debian-aarch64:1.0.0 .


FROM crpi-p35inr9lrgirg3t0.cn-hangzhou.personal.cr.aliyuncs.com/yaobo-box/debian:11 AS cross-base
RUN apt-get update
RUN apt-get install --assume-yes --no-install-recommends \
    autoconf \
    automake \
    binutils \
    ca-certificates \
    curl \
    file \
    gcc \
    git \
    sudo \
    wget \
    libtool \
    m4 \
    g++ \
    gfortran \
    libc6-dev \
    apt-utils \
    libclang-dev \
    libevdev-dev \
    libssl-dev \
    pkg-config


# 设置 Rust 中国镜像
RUN export RUSTUP_DIST_SERVER=https://rsproxy.cn
RUN export RUSTUP_UPDATE_ROOT=https://rsproxy.cn/rustup

# 安装 Rust
RUN curl https://sh.rustup.rs -sSf > /tmp/rustup-init.sh \
    && chmod +x /tmp/rustup-init.sh \
    && sh /tmp/rustup-init.sh -y \
    && rm -rf /tmp/rustup-init.sh

# 设置 PATH
RUN PATH="~/.cargo/bin:${PATH}" 
ENV PATH "$PATH:~/.cargo/bin" 
RUN ~/.cargo/bin/cargo search 
# 验证安装
RUN ~/.cargo/bin/rustc --version

# 安装 protoc
COPY ./tool/protoc-3.20.1-linux-x86_64/bin/protoc /usr/local/bin/protoc
RUN chmod +x /usr/local/bin/protoc


FROM cross-base AS build

# 安装交叉编译工具链
RUN apt-get update && apt-get install --assume-yes --no-install-recommends \
    g++-aarch64-linux-gnu \
    gfortran-aarch64-linux-gnu \
    libc6-dev-arm64-cross \
    qemu-user-static \
    && rm -rf /var/lib/apt/lists/*

# 设置交叉编译环境
ENV CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc \
    CC_aarch64_unknown_linux_gnu=aarch64-linux-gnu-gcc \
    CXX_aarch64_unknown_linux_gnu=aarch64-linux-gnu-g++ \
    AR_aarch64_unknown_linux_gnu=aarch64-linux-gnu-ar

# 添加目标平台
RUN rustup target add aarch64-unknown-linux-gnu